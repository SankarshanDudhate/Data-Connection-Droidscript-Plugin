
/*
	DroidScript Plugin class.
	(This is where you put your plugin code)
*/

package com.sandudhate.plugins.user;

import android.os.*;
import android.content.*;
import android.util.Log;
import android.graphics.*;
import java.io.*;
import java.lang.reflect.*;
import android.content.Context;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;

public class NetChecker
{
	public static String TAG = "NetChecker";	
	public static float VERSION = 1.0f;	
	private Method m_callscript;
	private Object m_parent;
	public static int TYPE_WIFI = 1;
	public static int TYPE_MOBILE = 2;
	public static int TYPE_NOT_CONNECTED = 0;

	//Script callbacks.
	private String m_OnMyReply;

	//Contruct plugin.
	public NetChecker()
	{
		Log.d( TAG, "Creating plugin object");
	}

	//Initialise plugin.
	public void Init( Context ctx, Object parent )
	{
		try {
			Log.d( TAG, "Initialising plugin object");

			//Save reference to parent (DroidScript).
			m_parent = parent;

			//Use reflection to get 'CallScript' method
			Log.d( TAG, "Getting CallScript method");
			m_callscript = parent.getClass().getMethod( "CallScript", Bundle.class );
		 } 
		 catch (Exception e) {
			   Log.e( TAG, "Failed to Initialise plugin!", e );
		 }
	}

	//Call a function in the user's script.
	private void CallScript( Bundle b )
	{
		try {
			m_callscript.invoke( m_parent, b );
		} 
		catch (Exception e) {
			Log.e( TAG, "Failed to call script function!", e );
		}
	}

	//Handle commands from DroidScript.
	public String CallPlugin( Bundle b, Context ctx)
	{
		//Extract command.
		String cmd = b.getString("cmd");
	
		//Process commands.
		String ret = null;
		try {
			if( cmd.equals("GetVersion") ) 
				return GetVersion( b );
			else if( cmd.equals("MyFunc") ) 
				MyFunc( b );
			else if( cmd.equals("SetOnMyReply") ) 
				SetOnMyReply( b );
			else if( cmd.equals("SaveMyImage") ) 
				SaveMyImage( b );
			else if( cmd.equals("GetConnectivityStatus") )
				GetConnectivityStatusString( ctx );
		} 
		catch (Exception e) {
		   Log.e( TAG, "Plugin command failed!", e);
		}
		return ret;
	}

	//Handle the GetVersion command.
	private String GetVersion( Bundle b )
	{
		Log.d( TAG, "Got GetVersion" );
		return Float.toString( VERSION );
	}
	
	//Handle the 'SetOnMyReply' command.
	private void SetOnMyReply( Bundle b )
	{
		Log.d( TAG, "Got SetOnMyReply" );
		m_OnMyReply = b.getString("p1");
	}

	//Handle the 'MyFunc' command.
	private void MyFunc( Bundle b )
	{
		Log.d( TAG, "Got MyFunc" );

		//Extract params from 'MyFunc' command.
		String txt = b.getString("p1");
		Log.d( TAG, "  txt = " + txt );
		float num = b.getFloat("p2");
		Log.d( TAG, "  num = " + num );
		boolean boo = b.getBoolean("p3");
		Log.d( TAG, "  bool = " + boo );
	
		//If 'OnReply' callback is set.
		if( m_OnMyReply!=null )
		{
			//Fire callback in script.
			b = new Bundle();
			b.putString( "cmd", m_OnMyReply );
			b.putString( "p1", txt + " World!!" );
			b.putFloat( "p2", num+20 );
			b.putBoolean( "p3", !boo );
			CallScript( b );
		}
	}

	//Handle 'SaveImage' command.
	private void SaveMyImage( Bundle b )
	{
		//Get byte array from bundle.
		byte[] byteArray = b.getByteArray("img");

		//Convert image to bitmap.
		Bitmap bmp = BitmapFactory.decodeByteArray( byteArray, 0, byteArray.length );

		//Save image to sdcard.
		String file = "/sdcard/NetChecker.jpg";
		Log.d( TAG, "Saving jpeg " + file );
		try {
			FileOutputStream outStream = new FileOutputStream( file );	
			bmp.compress( Bitmap.CompressFormat.JPEG, 95, outStream );
			outStream.close();		
		} 
		catch(Exception e) {
			Log.e( TAG, "SaveMyImage failed", e );
		} 
	}
	
	public static int getConnectivityStatus(Context ctx) {
		ConnectivityManager cm = (ConnectivityManager) ctx
			.getSystemService(Context.CONNECTIVITY_SERVICE);

		NetworkInfo activeNetwork = cm.getActiveNetworkInfo();
		if (null != activeNetwork) {
			if(activeNetwork.getType() == ConnectivityManager.TYPE_WIFI)
				return TYPE_WIFI;

			if(activeNetwork.getType() == ConnectivityManager.TYPE_MOBILE)
				return TYPE_MOBILE;
		} 
		return TYPE_NOT_CONNECTED;
	}

	public static String GetConnectivityStatusString(Context ctx) {
		int conn = NetChecker.getConnectivityStatus(ctx);
		String status = null;
		if (conn == NetChecker.TYPE_WIFI) {
			status = "Wifi enabled";
		} else if (conn == NetChecker.TYPE_MOBILE) {
			status = "Mobile data enabled";
		} else if (conn == NetChecker.TYPE_NOT_CONNECTED) {
			status = "Not connected to Internet";
		}
		return status;
	}



} 

